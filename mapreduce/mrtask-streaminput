#!/usr/bin/perl

# mrtask-streaminput: read keys on stdin, output contents to stdout

use strict;
use MogileFS::Client;

my $mogc;

my $retries = 0;
while(defined ($_ = <STDIN>))
{
  chomp;
  if (!defined $mogc)
  {
    $mogc = eval {
      MogileFS::Client->new
	  (domain => $ENV{MOGILEFS_DOMAIN},
	   hosts => [split(",", $ENV{MOGILEFS_TRACKERS})]);
      };
    if (!$mogc)
    {
      warn "MogileFS connect [$ENV{MOGILEFS_DOMAIN} at $ENV{MOGILEFS_TRACKERS}] failed";
    }
  }
  my $bufref = $mogc->get_file_data ($_);
  if (!$bufref)
  {
    warn "MogileFS get_file_data($_) failed: " . $mogc->errstr;
    die if ++$retries > 5;
    undef $mogc;
    sleep 1;
    redo;
  }
  print $$bufref;
  $retries = 0;
}
