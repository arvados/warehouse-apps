#!/usr/bin/perl

# mrtaskmanager: run a map or reduce function on one input.

use strict;

eval {
    # limit to 4GB virtual memory if libbsd-resource-perl is installed
    use BSD::Resource;
    setrlimit(RLIMIT_AS, 2**32, 2**32);
};

$ENV{PATH} .= ":$ENV{MR_REVISION_INSTALLDIR}/bin";
$ENV{PATH} .= ":$ENV{MR_REVISION_SRCDIR}/warehouse/client";
$ENV{PATH} .= ":$ENV{MR_REVISION_SRCDIR}/mapreduce";
$ENV{PATH} .= ":$ENV{MR_REVISION_INSTALLDIR}/src/mapreduce";
$ENV{PERLLIB} .= "$ENV{MR_REVISION_SRCDIR}/warehouse/lib:$ENV{MR_REVISION_INSTALLDIR}/src/warehouse/lib:$ENV{MR_REVISION_SRCDIR}/mapreduce:$ENV{MR_REVISION_INSTALLDIR}/src/mapreduce";

$ENV{MR_JOB_TMP} = "/tmp/mrcompute/work";
$ENV{MR_JOBSTEP_TMP} = "/tmp/mrcompute/work/$ENV{MR_SLOT}";
system "rm -rf '$ENV{MR_JOBSTEP_TMP}'";
mkdir $ENV{MR_JOB_TMP};		# usually fails silently, needed for 1st step
mkdir $ENV{MR_JOBSTEP_TMP};

$ENV{TMPDIR} = $ENV{MR_JOBSTEP_TMP};

foreach (split ("\n", $ENV{MR_KNOBS}))
{
  my ($k, $v) = split ("=", $_, 2);
  $ENV{"KNOB_$k"} = $v;
}

$ENV{NOCACHE} ||= $ENV{KNOB_NOCACHE};
$ENV{NOCACHE_READ} ||= $ENV{KNOB_NOCACHE_READ};
$ENV{NOCACHE_WRITE} ||= $ENV{KNOB_NOCACHE_WRITE};

open STDOUT, ">/dev/null";
exec "mr-$ENV{MR_FUNCTION}";
die "mr-$ENV{MR_FUNCTION}: $!";
