Install prerequisites:

 sudo apt-get install libcache-memcached-perl libmogilefs-client-perl

Create accounts and database for warehouse system:

 create database warehouse;
 grant all privileges on warehouse.* to whserver@'%';
 set password for whserver@'%' = old_password('YOURPASSWORDHERE');

Give the warehouse user permission to use the mapreduce database:

 grant all privileges on mapreduce.* to whserver@'%';

Extract current version:

 cd /tmp
 svn co http://dev.freelogy.org/svn/polony/polony-tools/trunk/warehouse
 cd ./warehouse

Create /etc/warehouse/warehouse-server.conf to suit:

 mkdir -p /etc/warehouse
 cp -i server/warehouse-server.conf.sample /etc/warehouse/warehouse-server.conf
 vi /etc/warehouse/warehouse-server.conf

Create database tables:

 su -u www-data -- sh -c 'cd server && perl setup.pl'

Create /etc/warehouse/warehouse-client.conf to suit -- see
../client/INSTALL for details.

Test and install the Perl API, server, and sample client programs:

 (
 set -ex
 perl Makefile.PL
 make
 make test
 make install
 )

Create a GPG key (DSA and Elgamal) with no passphrase for
root@controller.

 sudo -H gpg --gen-key
 (echo; echo always-trust) | sudo tee -a ~root/.gnupg/gpg.conf

Create supervised service:

 (
 set -ex
 sudo apt-get install runit
 
 d=/var/service/warehoused
 sudo mkdir -p $d/log/main
 sudo chmod +t $d
 (echo '#!/bin/sh'; echo 'exec svlogd -tt main') \
   | sudo bash -c "cat >$d/log/run"
 (echo '#!/bin/sh'; echo 'exec warehoused 2>&1') \
   | sudo bash -c "cat >$d/run"
 sudo chmod +x $d/run $d/log/run

 d=/var/service/warehouse-watchdog
 sudo mkdir -p $d/log/main
 sudo chmod +t $d
 (echo '#!/bin/sh'; echo 'exec svlogd -tt main') \
   | sudo bash -c "cat >$d/log/run"
 (echo '#!/bin/sh'; echo 'exec warehouse-watchdog 2>&1') \
   | sudo bash -c "cat >$d/run"
 sudo chmod +x $d/run $d/log/run

 d=/var/service/whjobinit
 sudo mkdir -p $d/log/main
 sudo chmod +t $d
 (echo '#!/bin/sh'; echo 'exec svlogd -tt main') \
   | sudo bash -c "cat >$d/log/run"
 (echo '#!/bin/sh'; echo 'exec sudo -u www-data whjobinit 2>&1') \
   | sudo bash -c "cat >$d/run"
 sudo chmod +x $d/run $d/log/run
 )

Give mrjobmanager a copy of the GPG secret key:

 sudo mkdir -m 0700 /var/service/whjobinit/.gnupg
 sudo chown www-data:www-data /var/service/whjobinit/.gnupg
 sudo -H gpg --export-secret-keys | HOME=/var/service/whjobinit sudo -u www-data gpg --import

Set up configurl handler in nginx:

 (
 set -ex
 sudo apt-get install nginx
 sudo tee /etc/nginx/sites-available/warehouse <<EOF >/dev/null
 server {
	 listen   44848;
	 server_name  localhost;
	 location / {
		 root   /var/run/warehouse;
	 }
 }
 EOF
 sudo ln -s ../sites-available/warehouse /etc/nginx/sites-enabled/
 sudo rm /etc/nginx/sites-enabled/default
 sudo /etc/init.d/nginx start
 )
