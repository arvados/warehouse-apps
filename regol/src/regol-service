#!/usr/bin/perl
# -*- mode: perl; perl-indent-level: 2; -*-

use strict;
use DBI;
use Warehouse;

do '/etc/regol.conf' or die "No config file /etc/regol.conf";

my $dbh = DBI->connect(@$main::DatabaseDSN)
    or die "DBI connect failed: ".DBI->errstr;

$main::drain = 0;
$SIG{TERM} = $SIG{HUP} = $SIG{INT} = sub { $main::drain = 1; };

setup_tables();

my $wh = $main::Warehouses;
foreach (keys %$wh)
{
  if ($wh->{$_}->{whc} = new Warehouse %{$wh->{$_}})
  {
    $dbh->do ("replace into warehouse (name, servers) values (?,?)", undef,
	      $_, $wh->{$_}->{warehouse_servers});
  }
  else
  {
    warn "Can't create new Warehouse object for $_";
    delete $wh->{$_};
  }
}

while (1)
{
  foreach (keys %$wh)
  {
    update_job_table($_);	# find out about new jobs from controller
    purge_todo_table($_);	# remove jobs after they start running
    if (count_todo($_) == 0)	# if all of my submitted jobs are running...
    {
      schedule_something($_);
    }
    exit 0 if $main::drain;
  }
  sleep (60);
  exit 0 if $main::drain;
}


sub update_job_table
{
  my $warehousename = shift;
  return undef unless $wh->{$warehousename}->{warehouse_servers};

  my $arrayref = $wh->{$warehousename}->{whc}->job_list
      or return undef;

  $dbh->do ("update warehouse set lastupdate=now() where name=?", undef,
	    $warehousename);

  foreach (@$arrayref)
  {
    $dbh->do ("insert ignore into job (warehousename, id) values (?,?)", undef,
	      $warehousename,
	      $_->{id});
    $dbh->do ("update job set
	       mrfunction=?, revision=?,
	       starttime=?, finishtime=?, success=?, knobs=?,
	       inputkey=?, outputkey=?, metakey=?
	       where warehousename=? and id=?",
	      undef,
	      $_->{mrfunction},
	      $_->{revision},
	      $_->{starttime} || undef,
	      $_->{finishtime} || undef,
	      defined $_->{success} ? $_->{success} : undef,
	      unescape ($_->{knobs}),
	      $_->{inputkey},
	      $_->{outputkey} || undef,
	      $_->{metakey} || undef,
	      $warehousename,
	      $_->{id});
  }
  $dbh->do ("update job set spec_md5=md5(concat(mrfunction,revision,inputkey,knobs))");
}


sub purge_todo_table
{
}


sub count_todo
{
  my $warehousename = shift;
  my $sth = $dbh->prepare ("select count(*) from todo where warehousename=?");
  $sth->execute ($warehousename) or return -1;
  my @r = $sth->fetchrow () or return -1;
  return $r[0];
}


sub schedule_something
{
}


sub setup_tables
{
  map { $dbh->do ($_) } split (/;\n/, <<EOF);

  create table if not exists job
  (
   warehousename char(64),
   id bigint,
   mrfunction char(32),
   revision bigint,
   starttime datetime,
   finishtime datetime,
   success tinyint,
   wantredo_nnodes int,
   wantredo_photons int,
   spec_md5 char(32),
   knobs text,
   inputkey text,
   outputkey text,
   metakey text,
   unique(warehousename,id)
  );
  alter table job add mrfunction char(32) after id;
  alter table job add revision bigint after mrfunction;
  alter table job add success tinyint after finishtime;
  alter table job add wantredo_photons int after wantredo_nnodes;
  alter table job add key spec_md5 (spec_md5);

  create table if not exists todo
  (
   warehousename char(64),
   id bigint,
   unique(warehousename,id)
  );

  create table if not exists warehouse
  (
   name char(64),
   servers char(255),
   lastupdate datetime,
   unique(name)
  );
EOF
    ;
}


sub unescape
{
  local $_ = shift;
  s/\\n/\n/g;
  s/\\\\/\\/g;
  $_;
}
